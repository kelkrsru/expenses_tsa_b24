{% extends 'base.html' %}

{% block title %}{{ title }}{% endblock %}
{% block content %}
  <div class="container mt-3 filter-menu">
    <div class="card card-calc">
      <div class="card-header blue">
        Действия
      </div>
      <div class="card-body">
        {% load user_filters %}
        <form method="post" action="{% url 'reports:report_buh' %}?member_id={{ member_id }}">
          {% csrf_token %}
          <div class="row row-cols-3 mb-2">
            {% for field in form %}
              <div class="form-group col">
                <label for="{{ field.id_for_label }}">
                  {{ field.label }}
                    {% if field.field.required %}
                      <span class="required text-danger">*</span>
                    {% endif %}
                </label>
                {% if field|fieldtype == 'Select' %}
                  {{ field|addclass:'form-select shadow-none mb-3' }}
                {% else %}
                  {{ field|addclass:'form-control shadow-none mb-3' }}
                {% endif %}
                  {% if field.help_text %}
                    <small
                       id="{{ field.id_for_label }}-help"
                       class="form-text text-muted"
                    >
                      {{ field.help_text|safe }}
                    </small>
                  {% endif %}
              </div>
            {% endfor %}
          </div>
          <div class="row row-cols-auto justify-content-end">
            <div class="col">
              <button
                      type="submit"
                      class="btn btn-primary shadow-none"
              >Применить</button>
            </div>
          </div>
        </form>
      </div>
      <div class="card-footer justify-content-end">
        <div class="row row-cols-auto justify-content-end">
          <div class="col">
            <button class="btn btn-success shadow-none" onclick="HtmlTOExcel('xlsx')">Выгрузить в Excel</button>
          </div>
          <div class="col">
            <a
                    href="{% url 'mainpage:index' %}?member_id={{ member_id }}"
                    class="btn btn-danger shadow-none"
            >На главную</a>
          </div>
        </div>
      </div>
    </div>
  <script>
</script>


  </div>
  <div class="container report-area">
    <table class="table table-border table-striped table-reports" id="report-buh">
      <thead>
        <tr>
          <th>Дата</th>
          <th>Поставщик</th>
          <th>Сделка</th>
          <th>Документ</th>
          <th>Сумма, руб.</th>
        </tr>
      </thead>
      <tbody>
          {% for expense in expenses_for_reports %}
            <tr>
              <td>{{ expense.date|date:"d.m.Y" }}</td>
              {% if expense.company %}
                <td><a href="https://{{ expense.portal_name }}/crm/company/details/{{ expense.company_id.id_b24 }}/" target="_blank">{{ expense.company }}</a></td>
              {% else %}
                <td>---</td>
              {% endif %}
              <td><a href="https://{{ expense.portal_name }}/crm/deal/details/{{ expense.deal_id }}/" target="_blank">Сделка №{{ expense.deal_id }}</a></td>
              {% if expense.document %}
                <td>{{ expense.document }}</td>
              {% else %}
                <td>---</td>
              {% endif %}
              <td>{{ expense.sum_expense }}</td>
            </tr>
          {% endfor %}
      </tbody>
    </table>

  </div>
{% endblock %}
{% block scripts %}
  <script>
    $(document).ready(function() {
      $("#report-buh").DataTable({
        searching: false,
        paging: false,
        info: false,
        autoWidth: false,
        language: {
          zeroRecords: 'Записи не найдены',
          emptyTable: 'Записи не найдены',
        },
        columnDefs: [
          { className: 'col-2', targets: [0, 2, 4] },
          { className: 'col-3', targets: [1, 3] },
        ]
      });
    });
  </script>
  <script>
    $(document).ready(function() {
      $('#import-excel').attr('disabled', false);
      var excel_data = $('#report-buh').html();
      $('#xls_data').val(excel_data);
    });
  </script>
  <script>
    function formatColumn(worksheet, col, fmt) {
      const range = XLSX.utils.decode_range(worksheet['!ref'])
      // note: range.s.r + 1 skips the header row
      for (let row = range.s.r + 1; row <= range.e.r; ++row) {
        const ref = XLSX.utils.encode_cell({ r: row, c: col })
        if (worksheet[ref] && worksheet[ref].t === 'n') {
          worksheet[ref].z = fmt
        }
      }
    }
    function HtmlTOExcel(type, fun, dl) {
      var elt = document.getElementById('report-buh');
      var wb = XLSX.utils.table_to_book(elt, { sheet: "ReportBuh", raw: true });
      var ws = wb.Sheets["ReportBuh"];
      const currency = '$0.00'
      for (let col of [4]) {
        formatColumn(ws, col, currency)
      }
      XLSX.utils.book_append_sheet(wb, ws, 'Details')
      {#ws["E2"].z = "0.00"; //  format the cell#}
      {##}
      {#delete ws["E2"].w; // delete old formatted text if it exists#}
      {#XLSX.utils.format_cell(ws["E2"]); // refresh cell#}
      return dl ?
          XLSX.write(wb, { bookType: type, bookSST: true, type: 'base64'}) :
          XLSX.writeFile(wb, 'report-buh.xlsx', {ignoreEC: false});
    }
  </script>
  <script>
    $(document).ready(function ()
    {
        $('#id_company').select2({
            theme: "bootstrap-5",
            selectionCssClass: "shadow-none",
        });
    });
  </script>
{% endblock %}
